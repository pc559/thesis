%\input{commands}
\chapter{Introduction II: Probing Inflation}\label{chapter:intro_bispectra}
\textcolor{red}{Put this somewhere:}
In this chapter we will review details of the bispectrum and how it is obtained.


The standard cosmological history, the $\Lambda CDM$ model, explains the structure we see in the distribution of matter (large-scale structure, LSS) and radiation (the cosmic microwave background, \textit{CMB}) in our universe. However, this model still requires initial conditions. These initial conditions – adiabatic perturbations on a uniform background, close to Gaussian, with a power spectrum that is nearly (but not exactly) scale-invariant – are provided by an epoch of “inflation”, an epoch before the Big Bang of the $\Lambda CDM$ model. 

During inflation, the universe is supposed to have expanded rapidly, stretching quantum fluctuations from small scales to large. This seeded the formation of structure and encoded correlations that we would eventually measure today.
Much information on fundamental physics has been gleaned from the two-point correlators of observations. For higher order correlators (which probe the non-linearities of interactions in the early universe) calculating the predictions of a model of inflation and comparing them to what we see in the sky is much more computationally intensive. Previous work, including that done by the Planck collaboration~\cite{Planck_NG_2018}, has managed to constrain some models of inflation through their three-point correlations (or rather through their proxy, the bispectrum).
The computational complexity was dealt with by making layers of approximations and the space
of models which could be constrained was limited.
One notable simplifying assumption is that of “separability”, which makes the process of \textit{CMB} estimation much more tractable~\cite{Komatsu_2005}.


The formalism used to calculate inflationary non-Gaussianities within an inflation scenario is
known as the in-in formalism~\cite{weinberg_in_in}\ldots




The primordial bispectrum is one of the main
characteristics used to distinguish between models of inflation. While it is well
known that the physics of inflation must have been extremely close
to linear, and the initial seeds of structure it laid down
very close to Gaussian, there is expected to have been some level of coupling
between the Fourier modes of the perturbations.
In the simplest example of an inflation model this is
expected to be unobservable~\cite{Maldacena},
but the possibility remains that inflation was driven by
more complex physics that may have left an observable imprint on our universe today.
Some models of inflation have interactions that predict non-Gaussian
correlations at observable levels. Ways this can happen include
self-interactions~\cite{px_burrage,dbi_in_the_sky},
interactions between multiple fields~\cite{Byrnes_2010, Gao_turn,
achucarro_multifield1, achucarro_multifield2, achucarro_robust_16, achucarro_natural,
achucarro_quad_viability, achucarro_gsr_cs_14, achucarro_cs_reduction_13,
achucarro_gong_cs_corr, achucarro_cs_12, achucarro_eft, curvaton_comprehensive},
sharp features~\cite{adshead, gsr, step_novaes}
and periodic features~\cite{flauger_pajer_resonant, Pajer_2013, Meerburg_2012, Meerburg_osc, Meerburg_2010,
Barnaby_2011, Peiris_2013, Easther_2013, Cabass_2018, Behbahani_2011}.
The link between primordial non-Gaussianity and primordial black
holes has also been studied~\cite{pbh_byrnes, pbh_young, pbh_franciolini, pbh_passaglia}.
Ultra slow-roll is a regime that has been explored~\cite{usr_chowdhury,usr_pattison,
usr_dimopoulos,usr_martin}
\textcolor{red}{Check those references!}
However, constraining such imprints is extremely difficult observationally.
Even once the data has been obtained, using existing methods it is
extremely computationally intensive to translate this into constraints
on specific inflation scenarios. Much progress has been made by course-graining
the model space into a small number of approximate templates,
and leveraging the simplifying characteristic of separability
with respect to the three parameters of the bispectrum~\cite{Komatsu_2005, Munchmeyer_2014}.


The primordial bispectrum is the Fourier equivalent of the
three-point correlator of the primordial curvature perturbation.
If this field is Gaussian, the bispectrum vanishes, so
it is a valuable measure of the interactions in play during inflation.
If some inflation model predicts a bispectrum that is sufficiently well approximated by
the standard separable templates, the constraints on those standard templates
can be translated into constraints on the parameters of the model.
The fact that all primordial templates estimated thus far from the CMB
are consistent with zero has already provided such constraints
in certain scenarios~\cite{Planck_NG_2015, Planck_NG_2018}.
With this high-precision \planck~data, and data from forthcoming experiments
such as the Simons Observatory (SO)~\cite{simons}
and CMB-S4~\cite{abazajian2016cmbs4},
robust pipelines must be developed to circumvent the computational difficulties and
extract the maximum amount of information possible.
Due to the nature of bispectrum estimation in the CMB and
LSS~\cite{lss_baldauf,lss_karagiannis,chen_future_lss,Scoccimarro_2012}
constraining an arbitrary template is difficult.
Our aim in this work is to develop the inflationary part
of a pipeline to allow to efficiently test a much broader range of models.
In this work, we explore shapes arising from tree-level effects in single field models.
We do this numerically, allowing quantitative results for a broad
range of models, and avoiding extra approximations.
Our general aim is to apply the modal philosophy of~\cite{FergShell_1,FergShell_2,FergShell_3}
to calculating primordial bispectra.
This modal philosophy is a flexible method that has broadened the range of constrained
bispectrum templates, by expanding them in a carefully chosen basis.
The Modal estimator is thus capable of constraining
non-separable templates, while the KSW estimator cannot.
In this work we exploit the intrinsic separability of the
tree-level in-in formalism to apply these methods at the level of inflation.
Expressing the primordial bispectrum in a separable
basis expansion leads to vast increases in efficiency both at the primordial
and late-universe parts of the calculation.
The main advantage is that expressing the primordial shape function
in this way reduces the process of bispectrum estimation in the CMB to a
cost which is large, but need only be paid once per basis,
not per scenario.
A proof of concept of this approach at the primordial level was presented in~\cite{Funakoshi},
and the details of the bispectrum estimation part will be detailed in~\cite{Sohn_2021}.
We go beyond the work of~\cite{Funakoshi} both in developing the choice of basis
(the feasibility of the method depending vitally on the chosen basis
achieving sufficiently fast convergence in a broad range of interesting models)
and in the methods we use to allow us to go to much higher order in our modal expansion,
allowing us to apply the method to feature bispectra for the first time.



\section{Perturbations about the background}
    We can get a lot of information on the evolution of the perturbations
    from observations, and that tells us about the history of universe,
    which tells us about its content, etc\ldots
    We now turn our attention to the details of the perturbations.


    The sound speed $c_s$~\eqref{sound_speed_definition} is
    the propagation speed of the perturbations.
    This defines a sound horizon, $c_s/H$---as the modes cross this sound
    horizon they freeze.


    The action for the perturbations is derived by working in a general gauge
    (using the ADM formalism) and splitting the relevant quantities into a background
    part and a small perturbation
    \begin{align}
        \phi(t,\vecx)=\bar{\phi}(t)+\delta\phi(t,\vecx), \qquad g_{\mu\nu}=\bar{g}_{\mu\nu}+\delta g_{\mu\nu}.
    \end{align}
    In the uniform density gauge we have (neglecting tensor modes)
    \begin{align}
        \delta \phi=0, \qquad h_{ij}=a^2 e^{2\zeta} \delta_{ij}
    \end{align}
    where $h_{ij}$ is the spatial part of the metric.
    %The relation between $\zeta$ in uniform density gauge and
    %$\delphi$ in spatially flat gauge is
    %\textcolor{red}{SOUND SPEED?}
    %\begin{align}
    %    \zeta=-\frac{\delphi}{\sqrt{2\varepsilon}a}.
    %\end{align}
    The second order action for the perturbations in this gauge can be found to be
    \begin{align}\label{zeta_action}
        S_{2} = \int d^3x dt~\frac{a\varepsilon}{c_s^2}\left(a^2\dot{\zeta}^2-c_s^2\left(\partial\zeta\right)^2\right)
    \end{align}
    Defining $v=-z\zeta$ and switching to conformal time we can rewrite this as
    \begin{align}\label{v_action}
        S_{2} = \frac{1}{2}\int d^3x d\tau \left[{\left(\frac{d v}{d \tau}\right)}^2-c_s^2\left(\partial v\right)^2+\frac{1}{z}\frac{d^2z}{d\tau^2}v^2\right]
    \end{align}
    where $z^2 = 2a^2\varepsilon/c_s^2 = a^2\left(\rho+P\right)/\left(c_sH\right)^2$.
    In terms of $v$, we can recognise the dynamics as that of a
    canonically normalised scalar field, oscillating
    with a frequency that changes as the universe expands.
    Expanding the mass, we find
    \begin{align}
        %\frac{z''}{z} = 2{\left(aH\right)}^2\left(1+\frac{\eta}{2}-\varepsilon_s\right)\left(1+\frac{\eta-2\epscs-2\varepsilon+2\eta'-4\epscs'}{4}\right)
        \frac{1}{z}\frac{d^2z}{d\tau^2} = 2{\left(aH\right)}^2\left(1+\ldots\right)
    \end{align}
    where \ldots~represents the terms that are slow-roll suppressed,
    so the evolution of the perturbations is well approximated using
    $\frac{1}{z}\frac{d^2z}{d\tau^2} = 2{\left(aH\right)}^2$
    unless there are features that make the slow-roll parameters large.

    \subsection{Evolution of the perturbations}\label{pert_evol}
    %https://nms.kcl.ac.uk/eugene.lim/AdvCos/lecture2.pdf
    %https://www.mpi-hd.mpg.de/lin/events/group_seminar/inflation/schmidt.pdf
    Varying the second order action~\eqref{zeta_action}, we can calculate the equation of motion
    of the perturbations.
    In terms of derivatives with respect to $N$, we obtain
    \begin{align}\label{modefneqn_zeta_N}
        {\zeta_k}'' + (3-\varepsilon+\eta-2\epscs){\zeta_k}'+\left(\frac{kc_s}{aH}\right)^2\zeta_k=0.
    \end{align}
    We can see that at late times, when $kc_s\ll aH$, $\zeta_k$ will freeze.
    This conservation of $\zeta$ outside the horizon~\cite{Lyth_conserved} is an
    important property\footnote{
    Systems with multiple degrees of freedom have $\zeta$ evolving even outside
    the horizon. See~\cite{Christopherson_2009} for a discussion on how this relates
    to non-adiabatic pressure in inflation models with non-canonical kinetic terms.}.
    This is useful as it means that $\zeta_k$ will then be frozen during the transition from inflation to the
    usual radiation dominated period, and we need only pick up the evolution again once it
    re-enters the horizon in the well-understood radiation era.


    From~\eqref{v_action}, in conformal time, we obtain the Mukhanov-Sasaki equation
    \begin{align}\label{modefneqn_tau}
        \frac{\partial^2 v_k}{\partial \tau^2} + \left(c_s^2k^2 - \frac{1}{z}\frac{d^2 z}{d \tau^2}\right)v_k = 0
    \end{align}
    however, this is not ideal as $c_s$ depends on time.
    Instead, let us use $\tau_s$ as our time parameter.
    If we follow~\cite{Hu_2011} and define
    \begin{align}
        y_k=\sqrt{2kc_s}v_k,
    \end{align}
    we obtain
    \begin{align}\label{modefneqn_tau_s}
        \frac{\partial^2 y_k}{\partial \tau_s^2} + \left(k^2 - 2\left(\frac{aH}{c_s}\right)^2(1+\ldots)\right)y_k = 0
    \end{align}
    where again \ldots~represents terms which are slow-roll suppressed.


    At early times, well before crossing the sound horizon at $c_sk=aH$,
    we have $k\gg aH/c_s$. We can see that the equation of motion becomes
    \begin{align}
        \frac{\partial^2 y_k}{\partial \tau_s^2} + k^2 y_k \approx 0
    \end{align}
    and we can clearly see that the solutions look like $y_k\propto e^{\pm ik\tau_s}$.
    %In practice we extract this oscillatory behaviour and numerically evolve $u_ke^{\mp ik\tau_s}$.


    \subsection{Early time behaviour}
    \subsubsection{Quantizing the perturbations}
    We now wish to quantize the perturbations.
    We will quantize $v$,
    as at early times it should behave like a free field in Minkowski space.
    We expand
    \begin{align}\label{operator_expansion}
        v(\tau,\vecx) &= \int\frac{d^3\veck}{(2\pi)^3}\left[
            v_k(\tau)\hat{a}_\veck e^{i\veck\cdot\vecx}+
            v^*_k(\tau)\hat{a}^{\dagger}_\veck e^{-i\veck\cdot\vecx}
        \right]\\
            &= \int\frac{d^3\veck}{(2\pi)^3}\left[
            v_k(\tau)\hat{a}_\veck +
            v^*_k(\tau)\hat{a}^{\dagger}_{-\veck}
        \right]e^{i\veck\cdot\vecx}
    \end{align}
    where $v_k(\tau)$ and $v^*_k(\tau)$ satisfy~\eqref{modefneqn_tau}.
    The creation and annihilation operators satisfy
    \begin{align}\label{creation_annihilation_commutator}
        \left[\ahat_{\veck},\ahat^{\dagger}_{\veck'}\right] = (2\pi)^3\delta^{(3)}(\veck-\veck').
    \end{align}
    Taking the commutator of $v$ and its conjugate momentum $\pi=\frac{dv}{d\tau}$
    \textcolor{red}{CHECK ALL OF THIS}
    we can obtain
    \begin{align}
        \left[v(\tau,\vecx),\pi(\tau,\mathbf{y})\right] &=
        \int \frac{d^3 \veck}{(2\pi)^3}\left(v_k\pi^*_k-\pi_kv^*_k\right)e^{i\veck\cdot(\vecx-\mathbf{y})}\\
        &= i \delta^{(3)}(\vecx-\mathbf{y})
    \end{align}
    if we demand that $v_k\pi^*_k-\pi_kv^*_k=1$.


    We can define the vacuum state by $\ahat_{\veck}\left| 0\right>=0$.
    Demanding this to be an eigenstate of $H$ forces $\pi_k=\pm ikv_k$.
    \textcolor{red}{How does this relate to before?}

    \subsubsection{Initial conditions for the perturbations}
    The Bunch-Davies vacuum leads us to the mode functions
    \begin{align}\label{uk_solution}
        \zeta_k(\tau) = \frac{H}{\sqrt{4\varepsilon c_s k^3}}\left(1-ikc_s\tau\right)e^{ic_s k\tau}.
    \end{align}
    The power spectrum is enhanced by a factor of $c_s$,
    \begin{align}
        P(k) = \frac{H^2}{4\varepsilon c_s k^3}
    \end{align}
    due to the larger prefactor.

    The vacuum is not unique. We choose it so that it
    asymptotes to the Minkowski vacuum in the limit $\tau\to-\infty$.

    Demanding that the early time behaviour matches that of flat space
    gives us that
    \begin{align}
        v_k = \frac{1}{\sqrt{2k}}e^{-ik\tau_s}
    \end{align}
    when $\tau_s\rightarrow -\infty$.
    \textcolor{red}{Is this really $\tau_s$ or $\tau$?}
    Assuming \textcolor{red}{assumptions} we can write the solution to the equations
    of motion in terms of the Hankel function $H^{(2)}_i$ as~\cite{px_burrage}
    \begin{align}
        \zeta_k = \frac{1}{2a}\sqrt{\frac{\pi}{2}}\sqrt{\frac{-\tau_s}{zc_s}}H^{(2)}_{\nu}\left[-k\tau_s\right].
    \end{align}
    where $\nu = \frac{3}{2}+\varepsilon+\frac{\eta}{2}+\frac{\epscs}{2}$
    \textcolor{red}{Rewrite this in terms of $\tau_s$. Citation?}

    \subsection{Late time behaviour}
    At late times we can use the limit
    \begin{align}
        \lim_{x\rightarrow 0}H^{(1)}_\nu(x)\rightarrow-\frac{i}{\pi}\Gamma(\nu)\left(\frac{x}{2}\right)^{-\nu}.
    \end{align}
    From this limiting behaviour we can calculate the power spectrum predicted by
    a $P(X,\phi)$ model, as a function of time and $k$.
    What we find \textcolor{red}{EXPAND!!} is that the time dependence
    of the prefactor $H^2/(4zc_s^3)$ is precisely canceled out by the time dependence
    of the limiting behaviour of the Hankel function, as expected.
    This means we can obtain the final power spectrum by evaluating
    it separately for each $k$. In fact, we choose to evaluate the asymptotic expression
    at sound-horizon crossing $c_sk=aH$. Note that we are \textit{not} evaluating
    $\zeta_k\zeta^*_k$ at horizon crossing---we are evaluating the asymptotic expression
    for that quantity there.


The equation of motion for the perturbations is~\eqref{modefneqn_zeta_N},
%\begin{align}\label{modefneqn}
%\zeta_k''+(3-\varepsilon+\eta-2\varepsilon_s)\zeta_k'+\frac{c_s^2k^2}{a^2H^2}\zeta_k=0
%\end{align}
where $c_s=1$ for standard canonical inflation.
We use standard Bunch-Davies initial conditions,
which leads us to impose the following condition deep in the horizon:
\begin{align}\label{bd_ic}
\zeta_k = \frac{i}{a}\sqrt{\frac{c_s}{4\varepsilon k}} e^{-ik\tau_s}
\end{align}
where $\tau_s$ is defined in~\eqref{tausdef}.
The solution in slow-roll (without features) is then approximately
\begin{align}\label{modefnsapprox}
    \zeta_k \propto (1+ik\tau_s)e^{-ik\tau_s}.
\end{align}
At leading order in slow-roll the power spectrum is~\cite{mukhanov_1999,chen_ng_0605}:
\begin{align}
P^{\zeta}(k) = \frac{1}{8\pi^2}\frac{H^2}{c_s\varepsilon},
\end{align}
where the right hand side is evaluated at $c_{s}k=aH$.
The spectral index is (also to leading order):
\begin{align}
n_s-1 = -2\varepsilon-\eta-\varepsilon_s.
\end{align}


Initially we consider the same basic models as in~\cite{Funakoshi};
a quadratic potential
\begin{align}\label{eq:quadratic_potential}
    \quadpot = \frac{1}{2}m^2\phi^2.
\end{align}
with a canonical kinetic term,
and a non-canonical model,
the DBI model described in \textcolor{red}{SECTION}.


    \section{The primordial power spectrum}
    Define the $\cmb$ power spectrum, discuss constraints.
    \textcolor{red}{Note we neglect ISW throughout. Mention polarisation, B-modes~\cite{Baumann_bmodes_2014}.\\
    How does this rule out e.g.\ $m^2\phi^2$?}


    In general when projecting a three dimensional random field onto a sphere (the $\cmb$ sky)
    the statistics are projected as
    \begin{align}
        \left<f_{lm}f^*_{l'm'}\right> = 4\pi \delta_{ll'}\delta_{mm'}
        \int d\ln k \mathcal{P}_{\mathcal{F}}(k) j_l^2(kr)
    \end{align}
    where $j_l(x)$ is a Bessel function, and the $\delta_{ll'}$ and $\delta_{mm'}$
    are demanded by statistical isotropy. The Bessel function encodes the fact that a three dimensional
    wave of a given wavelength intersects the sphere at multiple different angular separations.


    The temperature anisotropies of the $\cmb$ are decomposed in spherical
    harmonics as
    \begin{align}
        \frac{\Delta T}{T}(\hat{\mathbf{n}}) &= \sum_{lm} a_{lm}Y_{lm}(\hat{\mathbf{n}})
    \end{align}
    and the power spectrum is
    \begin{align}
        C_l &= \sum_m a_{lm} a_{l-m}.
    \end{align}
    The variance is given by
    \begin{align}
        var\left(\hat{C}_l\right) = \frac{2}{2l+1} C^2_l,
    \end{align}
    which reflects the fact that for the distribution of $C_l$,
    there are $2l+1$ independently draws that we can observe.

    The $\cmb$ power spectrum $C_l$ is calculated from the primordial power spectrum $\primpowerspec$
    using a transfer function
    \begin{align}\label{eqn:transfer_function}
        C_l \approx 4\pi\int d\ln k~\primpowerspec(k)
            \Delta_l(k).
    \end{align}
    For large scales, where there was not enough time for oscillations
    before recombination, there is no processing of the primordial statistics
    and the transfer function simply encodes the projection effects
    \begin{align}
        C_l \approx 4\pi\int d\ln k~\primpowerspec(k){\left[
            j_l(k\chi_*)/5
            \right]}^2.
    \end{align}
    For large $l$ the spherical Bessel functions have a sharp peak when $k\chi_*=l$,
    so for large $l$ we see that $C_l$ is mostly determined by $\primpowerspec(l/\chi_*)$.
    For $\primpowerspec(k)=A_s$, i.e.\ perfectly scale invariant,
    we can use that
    \begin{align}
        \int_0^{\infty}d\ln x~j_l^2(x) = \frac{1}{2l(l+1)}
    \end{align}
    to find that $l(l+1)C_l\propto \text{const}$, i.e.\ that on large scales
    (so small $l$) this quantity is independent of $l$.


    For intermediate scales, the acoustic oscillations and the Doppler effect
    becomes relevant, and the transfer function additionally encodes this processing
    \begin{align}
        C_l \approx 4\pi\int d\ln k~\primpowerspec(k){\left[
            \frac{(\Theta_0+\psi)(\eta_*,\mathbf{k})}{\mathcal{R}(\mathbf{k})}j_l(k\chi_*)
            -\frac{v_\gamma(\eta_*,\mathbf{k})}{\mathcal{R}(\mathbf{k})}j'_l(k\chi_*)
            \right]}^2.
    \end{align}
    \textcolor{red}{Derivative of $j$ with respect to its argument.}


    For small scales, diffusion of photons escaping \textcolor{red}{pressure waves??}
    damps out the sharp peaks of the acoustic oscillations.


\section{The primordial bispectrum}
    \subsection{The shape function}
    \textcolor{red}{Shape versus scale dependence.}
The primordial bispectrum is usually written as:
\begin{align}\label{bispectrum_definition}
{
\left< \zeta_{\bf{k_1}}\zeta_{\bf{k_2}}\zeta_{\bf{k_3}} \right>
= (2\pi)^3\delta^{(3)}(\mathbf{k_1}+\mathbf{k_2}+\mathbf{k_3})B(k_1,k_2,k_3)
}
\end{align}
where $\zeta_{\bf{k}}$ is a Fourier mode of the standard gauge invariant curvature perturbation.
The delta function comes from demanding statistical homogeneity;
demanding statistical isotropy restricts the remaining dependence to the magnitudes of the vectors.
We denote the magnitude of $\mathbf{k_i}$ as $k_i$.
This leaves us with a function of three parameters,
$k_1,k_2,k_3$.
It is useful to define the dimensionless shape function:
\begin{align}\label{shapefn}
{
    S(k_1,k_2,k_3) = (k_1k_2k_3)^2B(k_1,k_2,k_3).
}
\end{align}
As we saw in~\ref{corr_functions}
the bispectrum is only defined where the triangle condition
\begin{align}\label{triangle_condition}
    \mathbf{k_1}+\mathbf{k_2}+\mathbf{k_3} &= 0,
\end{align}
is satisfied, which implies that the triangle inequality must hold
\begin{align}\label{triangle_inequality}
    k_1+k_2 &\geq k_3~\text{and cyclic perms}.
\end{align}
The space of configurations we are interested in is therefore
reduced from the full cube $[\kmin,\kmax]^3$
to a tetrapyd (illustrated in figure~\ref{slice_explained}),
the intersection of that cube with the
tetrahedron that satisfies~\eqref{triangle_inequality}.
This has important implications that we will explore in
chapter~\ref{chapter:decomp}. 


The amplitude of a bispectrum shape is usually
quoted in terms of some $\fnl^F$ parameter.
We can schematically define $\fnl^F$ for some template $F$ as follows:
\begin{equation}\label{def:fnl}
{
B^{F}(k_1,k_2,k_3) = \fnl^{F}\times F(k_1,k_2,k_3)
}
\end{equation}
where $F$ contains the dependence on the $k$-configuration.
This definition coincides with the definitions of
$\fnllocal$, $\fnlequil$ and $\fnlortho$
when $F$ is (respectively) the local (see~\eqref{local_shape}),
equilateral (see~\eqref{equil_shape}) and orthogonal templates,
as defined in~\cite{Planck_NG_2013, Planck_NG_2015}.

    \section{A field guide to the definitions of $\fnl$}
    In our template-free pipeline, we take $\fnl$ as a coefficient of our expansion
    of the numerically calculated primordial shape. Thus, for us, we rule out an
    inflation scenario by ruling out $\fnl=1$. There are, however, many competing
    definitions and conventions for $\fnl$ in the literature, especially between
    the observations-side and the primordial-side. We list some below, for convenience.


    For the local form, we have \textcolor{red}{Check prefactor!}
    \begin{align}\label{fnllocal_quadratic}
        \zeta(\vecx) = \zeta_G(\vecx) - \frac{3}{5}\fnllocal\left(\zeta_G(\vecx)^2-\left<\zeta_G(\vecx)^2\right>\right)
    \end{align}
    where $\zeta_G(\vecx)$ is a Gaussian field. The parameter $\fnllocal$ therefore has a clear
    interpretation as parametrising the deviation from Gaussianity. From this form,
    one obtains a bispectrum of the form~\eqref{local_shape}.


    In~\cite{Planck_NG_2013}, $\fnl$ is defined individually for each template, in such a way
    that for some template $X$, in the equilateral limit $k_1=k_2=k_3$
    \begin{align}\label{planck_fnl_defn}
        B^X_\Phi(k,k,k) = \frac{6A_\phi^2\fnl^X}{k^6},
    \end{align}
    for example equation $(5)$ in~\cite{Planck_NG_2013},
    or
    \begin{align}\label{planck_fnl_defn_ns}
        B^X_\Phi(k,k,k) = \frac{6A_\phi^2\fnl^X}{k^{8-2n_s}},
    \end{align}
    as in equation $(6)$ in~\cite{Planck_NG_2013}.
    The parameter $A_\phi$ comes from
    \begin{align}
        P_\Phi(k) = \frac{A_\phi}{k^{4-n_s}}\approx\left(\frac{3}{5}\right)^2\frac{H^2}{4\varepsilon c_sk^{4-n_s}}
    \end{align}
    where we used $\Phi=\frac{3}{5}\zeta$ and the slow-roll result for $\primpowerspec$.
    In~\cite{seery_ng_0503, chen_ng_0605, dbi_in_the_sky} $\fnl$ is similarly defined in terms
    of the shape function evaluated on equilateral triangles,
    as the templates considered had no scale dependence.
    One particular example is the DBI template, which we will present explicitly in~\eqref{dbi_shape}.
    For now, we briefly state the definition of $\fnl^{DBI}$, from~\cite{Planck_NG_2013}
    \begin{align}
        B^{DBI}_\Phi(k,k,k) = \frac{6A_\phi^2\fnl^{DBI}}{k^{6}}.
    \end{align}
    Comparing to~\eqref{dbi_shape}, we find that
    \begin{align}\label{fnl_dbi_defn}
        \fnl^{DBI} = -\frac{35}{108}\left(c_s^{-2}-1\right).
    \end{align}


    In~\cite{px_burrage, transport_main} we see $\fnl$ defined as the reduced bispectrum
    \begin{align}\label{transport_fnl_defn}
        \fnl(k_1,k_2,k_3) = \frac{5}{6}\frac{B(k_1,k_2,k_3)}{P(k_1)P(k_2)+P(k_1)P(k_3)+P(k_2)P(k_3)},
    \end{align}
    which clearly (except for the local case) depends on $k_1$, $k_2$ and $k_3$.


    For completeness, we also note another possible point of notational confusion.
    In~\cite{px_burrage} the definition $s^{there}=d\ln c_s/dN$ is used, however we refer to this
    quantity (as we defined in~\eqref{slowrollparams}) as $\epscs$.
    In~\cite{Hu_2011}, the quantity referred to as $s$ is the integral of the sound speed
    with respect to conformal time---we refer to this quantity as $\tau_s$,
    which we defined in~\eqref{tausdef}.
    In~\cite{warp_features_dbi}, $\tau_s^{here}$ is also referred to as $s$,
    but $\epscs^{here}$ is referred to as $\sigma_1$.
    This is summarised in table~\ref{tab:notation}.


\begin{table}[h!]
  \begin{center}
    \begin{tabular}{ccccc}
        \toprule
        Here & Definition &~\cite{px_burrage}&~\cite{Hu_2011} &~\cite{warp_features_dbi}\\
        \midrule
        $\tau_s$ &~\eqref{tausdef} & ~ & $s$ & $s$ \\
        $\epscs$ &~\eqref{slowrollparams} & $s$ & ~ & $\sigma_1$ \\
        \bottomrule
    \end{tabular}
    \caption{
        Notation summary and comparison.
        \textcolor{red}{Check N/A's. What about $X=\frac{1}{2}\dphi^2$ vs.\ $X=\dphi^2$?}
    }\label{tab:notation}
  \end{center}
\end{table}


    \subsection{Templates}
    The momentum dependence of the various possible bispectrum shapes can be complex
    and it is therefore useful to define a standard notation in which to express this dependence.
    For example in~\cite{Fergusson_2010, Pajer_boostless_2020} the elementary
    symmetric polynomials are used to compactly represent the results in a way that is manifestly
    symmetric\footnote{This representation is useful here in presenting analytic templates, however in performing
    our calculations we will require a one-dimensional basis, not a basis in three variables.
    There are also numerical advantages to the Legendre polynomials, as discussed in~\cite{Fergusson_2010}.}.


In this work we will use the notation employed in~\cite{FergShell_2}:
\begin{align}\label{shape_notation}
\begin{split}
    K_p &= \sum_{i=1,2,3} k_i^p, \\
    K_{pq} &= \frac{1}{\Delta_{pq}}\sum_{i\neq j} k_i^p k_j^q,   \\
    K_{prs} &= \frac{1}{\Delta_{prs}}\sum_{i\neq j\neq l} k_i^p k_j^r k_l^s,
\end{split}
\end{align}
where $\Delta_{pq}$ is $2$ if $p=q$, $1$ otherwise
and $\Delta_{prs}$ is $6$ if $p=r=s$, $2$ if $p=r\neq s$ (and permutations),
and $1$ if $p,r,s$ are all distinct.


    The local template is the shape which results from assuming the perturbation is
    quadratic in a Gaussian field~\textcolor{red}{Shouldn't be dimensionless, check
    this everywhere. Note on $n_s$, that's wrong here too.
    Connect to~\eqref{fnllocal_quadratic}
    The three basic phenomenological templates, \planck.
    $f_{NL}$ from the data analysis perspective,
    and from the primordial perspective.
    }
\begin{align}\label{local_shape}
S^{local}(k_1,k_2,k_3)
    &= \frac{6}{5}A_\zeta^2\fnllocal\frac{k_1^2}{k_2k_3}+\frac{k_2^2}{k_3k_1}+\frac{k_3^2}{k_1k_2}\\
    &= \frac{6}{5}\fnllocal\bigg(
        \primpowerspec(k_2)\primpowerspec(k_3)
        +\primpowerspec(k_3)\primpowerspec(k_1)
        +\primpowerspec(k_1)\primpowerspec(k_2)
    \bigg)\\
    &= \frac{6}{5}A_\zeta^2\fnllocal\frac{K_3}{6\,K_{111}}.
\end{align}
This template peaks on squeezed triangles, i.e.\ when $k_1\sim k_2\gg k_3$.
    The local template is used to test for multi-field effects~\cite{Planck_NG_2015}.


    Non-Gaussianity arising from gravitational collapse \textcolor{red}{CHECK THIS}
    and from inflation with a non-canonical kinetic term can be described by the
    equilateral template
\begin{align}\label{equil_shape}
    S^{equil}(k_1,k_2,k_3)
    &= \frac{18}{5}A_\zeta^2\fnlequil\frac{(k_2+k_3-k_1)(k_3+k_1-k_2)(k_1+k_2-k_3)}{k_1k_2k_3}\\
    &= \frac{18}{5}A_\zeta^2\fnlequil\frac{K_3??}{6\,K_{111}??}.
\end{align}
This template peaks on equilateral triangles, i.e.\ when $k_1\sim k_2\sim k_3$.




    \section{Step 1: the interaction Hamiltonian}
    \subsection{Constraints}
    Since General Relativity has a diffeomorphism invariance, it has a redundancy
    which must be settled before the true degrees of freedom are manifest.
    One does this by decomposing the metric (typically in the $ADM$ formalism)
    and expanding the action \textcolor{red}{is this what I want?}
    \begin{align}\label{gr_action}
        S=\int dx^4\sqrt{g}\left[\frac{R}{2}-\frac{1}{2}(\nabla\phi)^2-V(\phi)\right]
    \end{align}
    to obtain the constraint equations---one can then solve the constraints
    (perturbatively, aided by choice of gauge) and substitute
    back into the action, leaving only the dynamical variables.
    At the level of the background one then obtains the Friedmann equations;
    at second order one obtains the quadratic action, which evolves the
    interaction picture fields; and at third order, one obtains the cubic
    interaction Hamiltonian.
    \textcolor{red}{Check this!}


    To write the Hamiltonian one needs the momentum $\pi$, conjugate to $\zeta$.
    For a simple Lagrangian such as $\mathcal{L}_0=\frac{1}{2}\dzeta^2$,
    we find $\pi=\dzeta$. However if the Lagrangian contains other cubic terms
    with an explicit $\dzeta$, this relation will change and may not be easily invertible.
    However one can show that it will still be true that $\mathcal{H}_{int}=-\mathcal{L}_{int}+\mathcal{O}(\zeta^4,\dzeta^4)$,
    so calculating the cubic interaction Hamiltonian to this order
    from the cubic interaction Lagrangian is trivial.


    We will work with a Hamiltonian that has been split into three parts,
    \begin{align}
        H = H_b + H_0 + H_{int},
    \end{align}
    where $H_b$ evolves the homogeneous background, $H_0$ is quadratic in $\zeta$ and evolves the free
    fields, and the interaction Hamiltonian $H_{int}$ contains the terms cubic and above.
    In practice we will only use the part cubic in $\zeta$, $H_{int}^{(3)}$, which we will use to calculate
    the higher order correlations coming from the interactions. We will occasionally drop the superscript and
    refer to the cubic interaction Hamiltonian as simply the interaction Hamiltonian $H_{int}$.


    \subsection{Interactions}\label{sec:interactions}
    Simpler derivation neglecting the metric perturbations to begin with.
    Discuss DBI, then $P(X, \phi)$.


    The DBI model has kinetic term
\begin{align}\label{eq:dbi_action}
    S_{DBI}=\int d^4x\sqrt{-g}\left(-\frac{1}{f(\phi)}\left(\left(1+f(\phi)\partial_\mu\phi\partial^\mu\phi\right)^{\frac{1}{2}}-1\right)-V(\phi)\right),
\end{align}
and we choose
\begin{align}\label{eq:dbi_warp}
    f(\phi)=\frac{\lambda_{DBI}}{\phi^4},\qquad
    V(\phi)=V_0-\frac{1}{2}m^2\phi^2,\qquad
    m=\sqrt{\beta_{IR}}H
\end{align}
in line with~\cite{Bean_ir_dbi, Chen_dbi}.


The energy-momentum tensor in~\eqref{einstein_equations}, in terms of the matter Lagrangian $\mathcal{L}_m$, is
\begin{align}
    T_{\mu\nu} = -2\frac{\partial \mathcal{L}_m}{\partial g^{\mu\nu}}
                + g_{\mu\nu}\mathcal{L}_m
\end{align}
which for a $P(X,\phi)$ model evaluates to
\begin{align}
    T_{\mu\nu} &= g_{\mu\nu}P(X,\phi)+P_{,X}(X,\phi)\partial_{\mu}\phi\partial_{\nu}\phi\\
            &\approx g_{\mu\nu}P(X,\phi)+2X\delta_{0\mu}\delta_{0\nu}P_{,X}(X,\phi).
\end{align}


    Following~\cite{Christopherson_2009, mukhanov_1999},
    we can then calculate the useful quantities
    \begin{align}
        P(X, \phi) &= -\frac{1}{f(\phi)}\left(\sqrt{1-f(\phi)X}-1\right)-V(\phi)\\
        P,_X(X, \phi) &= \frac{1}{2\sqrt{1-f(\phi)X}}\\
        \rho(X, \phi) &= \frac{X}{\sqrt{1-f(\phi)X}}-P(X,\phi)\\
                    &= \frac{1}{\sqrt{1-f(\phi)X}}(P+V)+V\\
        \rho,_X(X, \phi) &= \frac{1}{2}\frac{1}{\left(1-f(\phi)X\right)^{\frac{3}{2}}}\\
        c^2_s(X, \phi) &= \frac{P,_X}{\rho,_X}\\
                    &= 1-f(\phi)X
    \end{align}
    \textcolor{red}{Factor of two in $P,_X$?}
    We see that, as expected, in the limit $\lambda_{DBI}\rightarrow 0$, the sound
    speed tends to unity.
    From this, we can calculate the $\phi$ equation of motion~\eqref{phieom}
    \begin{align}
        \phi'' &= -(3c_s^2-\varepsilon)\phi'
                -\frac{3f_\phi(\phi)}{2f(\phi)}\phi'^2
                +\frac{f_\phi(\phi)}{H^2f(\phi)^2}
                -\left(V_\phi(\phi)+\frac{f_\phi(\phi)}{f(\phi)^2}\right)\frac{c_s^3}{H^2}.
    \end{align}
    This can be compared with the equations of motion presented in~\cite{dbi_silverstein}
    and~\cite{warp_features_dbi}.
    See also~\cite{cmb_pol_ics} for a brief discussion on setting consistent initial conditions.


    We can now evolve $\tau_s$, $\phi$ and $H$ numerically
    using~\eqref{tausdef},~\eqref{phieom} and~\eqref{PXepsilon} respectively.
    In the examples we use, we set the initial conditions by prescribing $\phi_{start}$,
    calculating an approximate value of $\phi'_{start, approx}$ using the slow-roll approximation,
    then using $\phi'_{start, approx}$ to obtain values for $c^{start}_s$ and $H_{start}$.
    Taking those values for the sound speed and Hubble parameter as exact, along with the
    prescribed value for $\phi_{start}$, we can calculate the corresponding exact value
    of $\phi'_{start}$ using the background Friedmann equation~\eqref{friedmann_1},
    obtaining consistent initial conditions to start our numerical evolution.
    This procedure was described in~\cite{warp_features_dbi}.
    \textcolor{red}{Is it exactly the same?}
    See~\cite{cmb_pol_ics} for a brief discussion on consistent initial conditions.
    We will discuss this further in section~\ref{sec:interactions}.


    \section{Step 2: the primordial bispectrum}\label{sec:inin_calc_example}
    \subsection{Using the in-in formalism}
    \textcolor{red}{
    Conditions for small non-Gaussianity,\\
    so we need non-canonical kinetic term, or features, or something.\\
    Cite~\cite{Bartolo_review_2004, Chen_review_2010, Babich_2004, Baumann_horizon_2011,
    Renaux-Petel_2015, Meerburg_clock}.}


    The standard starting point for calculating
higher-order correlators for models of inflation is the in-in formalism~\cite{Maldacena,weinberg_in_in}.
The in-in formalism takes the time evolution of the interaction picture mode
functions as an input for calculating the bispectrum.
At tree-level, the in-in formalism gives us the
following expression:
\begin{align}
{
    \left< \zeta_{\mathbf{k_1}}(\tau)\zeta_{\mathbf{k_2}}(\tau)\zeta_{\mathbf{k_3}}(\tau) \right>
=-i\int_{-\infty(1-i\varepsilon)}^{\tau}d\tau'a(\tau')
    \left<0\lvert \zeta_{\mathbf{k_1}}(\tau)\zeta_{\mathbf{k_2}}(\tau)\zeta_{\mathbf{k_3}}(\tau)\Hint(\tau') \rvert0\right>+c.c\label{in-in}
}
\end{align}
where all the operators on the right-hand side are in the interaction picture
and $\Hint$ is the interaction Hamiltonian, containing terms cubic in $\zeta$.
From this calculation we obtain the dimensionless shape function $S(k_1,k_2,k_2)$,
defined in~\eqref{shapefn},
which is then used as input into~\eqref{eq:reduced_cmb}.
As an example, if one takes $\Hint\propto\dot{\zeta}^3$, this set-up can produce the standard EFT shape
\textcolor{red}{expand on this}
\begin{align}\label{example_eft2}
    S(k_1, k_2, k_3) = \frac{k_1k_2k_3}{(k_1+k_2+k_3)^3}.
\end{align}

The central point, as noticed in~\cite{Funakoshi}, is that the
integrand of~\eqref{in-in} is intrinsically separable
in its dependence on $k_1$, $k_2$ and $k_3$, and that the time integral
can be done in such a way as to preserve this separability.
This intrinsic separability has clearly been lost in
the example in~\eqref{example_eft2},
but can be regained (to arbitrary precision) by approximating it
with a sum of separable terms. Our general aim will be to directly calculate
this sum for a broad range of inflation models.

We now briefly outline the set-up of the standard calculation.
The Lagrangian is expanded in the perturbations and used to obtain the Hamiltonian.
The Hamiltonian is split into $H_0$ and $\Hint$.
The first part is used to evolve the interaction picture fields, $\zeta_I$,
which we will simply refer to as $\zeta$, as in~\eqref{in-in}.
The perturbations see an interaction Hamiltonian $\Hint$,
of which we will consider the part cubic in the perturbations,
with time dependent coefficients due to the evolution of the background fields.
The perturbations are assumed to be initially in the Bunch-Davies vacuum,
but the non-linear
evolution introduces correlations between the modes.
As the modes cross the horizon they begin to behave classically
and eventually freeze out.


There is some freedom in how to represent the interaction Hamiltonian,
as the equation of motion of the free fields can be used, along with integration by parts~\cite{rp_integ_by_parts}.
This can be used, as pointed out in~\cite{Funakoshi}, to avoid numerically difficult cancellations.
Some presentations of this calculation use a field redefinition to eliminate terms
proportional to the equation of motion from the Lagrangian.
As pointed out in~\cite{px_burrage},
this is unnecessary as these terms will never contribute to the bispectrum result.
In fact, in some scenarios (such as resonant models) it introduces a numerically difficult
late time cancellation between a term in the interaction Hamiltonian and the
correction to the correlator that adjusts for the field redefinition.


The bispectrum arising from a single field inflation model,
with a canonical kinetic term, slowly rolling, turns out to produce
unobservably small non-Gaussianity~\cite{Maldacena}.
However, by breaking these assumptions large signals can arise.
These signals are usually calculated using~\eqref{in-in} within tailored approximations.
The results are not always separable, so further approximations must then be made to
allow comparison with the CMB.


We now detail an explicit example of an in-in calculation.
We will take
\begin{align}\label{hint_example}
    \Hint=\int d^3x~g(t) a^3{\left(\dzeta^I\right)^3}
\end{align}
where $g(t)$ is some function of time.
This example is particularly simple as it contains no spatial derivatives.
We will include those when we outline our formalism fully in section~\ref{sec:main_notation}.
We wish to calculate
\begin{align}\label{inin_example}
    \left<\zeta_{\mathbf{k_1}}(t)\zeta_{\mathbf{k_2}}(t)\zeta_{\mathbf{k_3}}(t)\right>&=
    \Re\left(\left<-2i \zeta^I_{\mathbf{k_1}}(t)\zeta^I_{\mathbf{k_2}}(t)\zeta^I_{\mathbf{k_3}}(t)
    \int_{-\infty(1+i\varepsilon)}^{t}dt'\Hint(t')
    \right>\right).
\end{align}
We note that the operators inside the expectation value on the right hand side are
time-ordered, as $t'\leq t$.
All the operators on the right hand side are in the interaction picture, though for
notational convenience we will drop the superscript $I$.
To proceed with this calculation we will use Wick's theorem
\begin{align}\label{wick}
    \left<0\left|\zeta_{\mathbf{k_1}}\ldots\zeta_{\mathbf{k_n}}\right|0\right>
    &= \left<0\left|:\zeta_{\mathbf{k_1}}\ldots\zeta_{\mathbf{k_n}}:~+:\sum~\text{pairwise contractions:}~\right|0\right>
\end{align}
where $:~:$ denotes normal ordering---ordering operators so that those
which annihilate $\left|0\right>$ are to the right and those which annihilate
$\left<0\right|$ are put to the left. Thus, if $:~:$ contains uncontracted
operators, the term vanishes inside $<~>$.


By ``$\sum$ pairwise contractions'' we mean the sum over every possible permutation of contracting one pair,
and of contracting two pairs, and so on.
The contraction of two operators $\zeta_{\mathbf{k_1}}$ and $\zeta_{\mathbf{k_2}}$
is defined as the difference between their time ordered product and their normal ordered product.
Since the operators are built up of creation and annihilation operators, this will simply
vanish, or
be proportional to the commutator of $\hat{a}$ and $\hat{a}^{\dagger}$.
In either case, it can be pulled out of the expectation value.
Therefore, the only surviving contribution will the term with every $\zeta_{\mathbf{k}}$
contracted in a pair.


To evaluate the pairwise contractions we will make use of the fact that, from~\eqref{operator_expansion},
\begin{align}
    \left<\zeta_{\mathbf{k_1}}(t_1)\zeta_{\mathbf{k_2}}(t_2)\right>
    &= \left<0\left|
            \left(u_{k_1}(t_1)\hat{a}_\mathbf{k_1} +
            u^*_{k_1}(t_1)\hat{a}^{\dagger}_{-\mathbf{k_1}}\right)
            \left(u_{k_2}(t_2)\hat{a}_\mathbf{k_2} +
            u^*_{k_2}(t_2)\hat{a}^{\dagger}_{-\mathbf{k_2}}\right)
        \right|0\right>\\
    &= \left<0\left|
            u_{k_1}(t_1)\hat{a}_\mathbf{k_1}
            u^*_{k_2}(t_2)\hat{a}^{\dagger}_{-\mathbf{k_2}}
        \right|0\right>\\
    &= u_{k_1}(t_1)u^*_{k_2}(t_2)\left<0\left|
            \left[\hat{a}_\mathbf{k_1},
            \hat{a}^{\dagger}_{-\mathbf{k_2}}\right]
        \right|0\right>\\
    &= u_{k_1}(t_1)u^*_{k_2}(t_2)(2\pi)^3\delta^{(3)}(\mathbf{k_1}+\mathbf{k_2})
\end{align}
where we used~\eqref{creation_annihilation_commutator}.


So, inserting~\eqref{hint_example} into~\eqref{inin_example}
and rewriting $\dzeta(\vecx)$ in terms of its Fourier transform,
we get
\begin{align}\label{inin_example_start}
    \left<\zeta_{\mathbf{k_1}}(t)\right.&\left.\zeta_{\mathbf{k_2}}(t)\zeta_{\mathbf{k_3}}(t)\right>\\
    &=\Re\left(\left<-2i \zeta_{\mathbf{k_1}}(t)\zeta_{\mathbf{k_2}}(t)\zeta_{\mathbf{k_3}}(t)
    \int_{-\infty(1+i\varepsilon)}^{t}dt'
    \int d^3x~\left(g(t) a^3\dzeta^3(\vecx,t')\right)
    \right>\right).
\end{align}
where the operators on the right hand side are in the interaction picture,
but we have dropped the $I$ for simplicity of notation.
Continuing, we replace $\zeta$ with its Fourier transform
\begin{align}\label{inin_example_2}
    \bigg<-2i \zeta_{\mathbf{k_1}}(t)&\zeta_{\mathbf{k_2}}(t)\zeta_{\mathbf{k_3}}(t)
    \int_{-\infty(1+i\varepsilon)}^{t}dt'
    \int d^3x~\left(g(t) a^3\dzeta^3(\vecx,t')\right)
    \bigg>\\
    =&\bigg<-2i \zeta_{\mathbf{k_1}}(t)\zeta_{\mathbf{k_2}}(t)\zeta_{\mathbf{k_3}}(t)
    \int_{-\infty(1+i\varepsilon)}^{t}dt'\left(g(t) a^3\right)\nonumber\\
    &\qquad\cdot
    \int \frac{d^3p}{(2\pi)^3}
    \frac{d^3q}{(2\pi)^3}
    \frac{d^3r}{(2\pi)^3}
    \dzeta_{\mathbf{p}}(t')
    \dzeta_{\mathbf{q}}(t')
    \dzeta_{\mathbf{r}}(t')
    \int d^3x e^{i\vecx\cdot(\mathbf{p}+\mathbf{q}+\mathbf{r})}
    \bigg>\\
    =&\bigg<-2i \zeta_{\mathbf{k_1}}(t)\zeta_{\mathbf{k_2}}(t)\zeta_{\mathbf{k_3}}(t)
    \int_{-\infty(1+i\varepsilon)}^{t}dt'\left(g(t) a^3\right)\nonumber\\
    &\qquad\cdot
    \int \frac{d^3p}{(2\pi)^3}
    \frac{d^3q}{(2\pi)^3}
    \frac{d^3r}{(2\pi)^3}
    \dzeta_{\mathbf{p}}(t')
    \dzeta_{\mathbf{q}}(t')
    \dzeta_{\mathbf{r}}(t')
    (2\pi)^3\delta^{(3)}(\mathbf{p}+\mathbf{q}+\mathbf{r})
    \bigg>.
\end{align}
We now perform the contractions. If we contract one of the $\zeta_{\mathbf{k_i}}$ with
another, then the delta function will force one of $\mathbf{p}$, $\mathbf{q}$
or $\mathbf{r}$ to be zero. Since we want $\zeta_\mathbf{k}$ to be a perturbation
and not a contribution to the background, this cannot contribute.
\textcolor{red}{CHECK THIS.}

The results of the contractions will therefore have the form
\begin{align}
    \left<\zeta_{\mathbf{k_1}}(t)\dzeta_{\mathbf{p}}(t')\right>
    &= u_{k_1}(t)\udot^*_{p}(t')(2\pi)^3\delta^{(3)}(\mathbf{k_1}+\mathbf{p}).
\end{align}
and permutations.
Using the delta functions to perform the momentum integrals,
switching to conformal time,
and recalling~\eqref{bispectrum_definition}, we obtain
\begin{align}\label{inin_computer}
    B(k_1, k_1,&k_3)
    =
    \Re\bigg(-2i u_{k_1}(0)u_{k_2}(0)u_{k_3}(0)\nonumber\\
    &\cdot\int_{-\infty(1+i\varepsilon)}^{0}d\tau'\bigg(g(\tau') a^4(\tau')\bigg)
    \udot^*_{k_1}(\tau')
    \udot^*_{k_2}(\tau')
    \udot^*_{k_3}(\tau')
    +\text{perms}
    \bigg).
\end{align}
If one wanted to numerically calculate the bispectrum resulting from~\eqref{hint_example},
one could use this form. Until this point we have assumed nothing about the solutions of the
equations of motion, and we have not made a slow-roll approximation (although we have
of course only included the tree-level effects).
After one had chosen some prescription for numerically implementing the
$i\varepsilon$ prescription, one would need to evolve a set of $u_{k}$
according to the equations of motion and then perform the above time integral.


This is the point where our work will diverge from the standard calculation---this
will be detailed in section~\ref{sec:k_dep}. For now, we merely note that
the integrand of~\eqref{inin_computer} is explicitly separable in $k_1$, $k_2$ and $k_3$.


We will now continue the calculation within the slow-roll approximation,
using~\eqref{uk_solution}. We approximate $g(\tau')$ and the slow-roll
parameters as constant, and use $a\approx-1/(H\tau)$.
We see that we will need to perform the following integral by parts
\textcolor{red}{sign?}
\begin{align}
    \int_{-\infty(1+i\varepsilon)}^{0}d\tau~\tau^2 e^{-ic_sK\tau}
    &= \frac{-2i}{c_s^3K^3}
\end{align}
where we recall $K=k_1+k_2+k_3$.
Using this, we finally obtain
\textcolor{red}{sign?}
\begin{align}
    S(k_1, k_2, k_3) = -3\frac{g H^5}{8\varepsilon^3}\frac{k_1k_2k_3}{(k_1+k_2+k_3)^3}
\end{align}
where the factor of $6$ comes from the different possible contractions, all
of which give the same result in this example.
We can make contact with $\fnl^{EFT2}$ of~\cite{Planck_NG_2018, Senatore_wmap_2009}
by setting $g(t)=-\frac{\varepsilon}{Hc_s^2}(1-c_s^2)\left(1+\frac{2\tilde{c}_3}{3c_s^2}\right)$
and recalling $\Phi=\frac{3}{5}\zeta$.
\textcolor{red}{Check this again!}


    \subsection{The squeezed limit consistency condition}
The squeezed limit of canonical single-field bispectra will not cause
observable deviations from a Gaussian universe,
due to a cancellation when switching to physical coordinates~\cite{Cabass_2016}.
Here, we will only consider primordial phenomenology
in comoving coordinates, so despite this cancellation,
the squeezed limit is still a useful validation test of our results,
using the standard single-field squeezed limit consistency condition~\cite{sqz_consistency,not_so_sqz}.
With $\mathbf{k_S}\equiv\left(\mathbf{k_2}-\mathbf{k_3}\right)/2 $:
\begin{align}\label{eq:sqz_consistency}
    S(k_1,k_2,k_3) = -\left[(n_s-1)|_{k_S}+\mathcal{O}\left(\frac{k_1^2}{k_S^2}\right)\right]P_{\zeta}(k_1)P_{\zeta}(k_S),
\ \ \  k_1\ll k_S
\end{align}
where $S(k_1,k_2,k_3)$ is again our dimensionless shape function.
That the error in the consistency relation decreases at least quadratically
in the long mode was shown in~\cite{not_so_sqz}.


    \subsection{Basic shapes}
    With a canonical kinetic term, the slow-roll result for the shape is:
\begin{align}\label{malda_shape}
    S^{Malda}(k_1,k_2,k_3) &= -\frac{1}{32}\frac{H^4}{12\varepsilon^2} \left( (3\varepsilon-2\eta)\frac{K_3}{K_{111}}+\varepsilon \left(K_{12}+8\frac{K_{22}}{K}\right) \right)
\end{align}
with $\eta=2\varepsilon$ for~\eqref{eq:quadratic_potential}.
At the primordial level, this is well approximated by the separable local template~\eqref{local_shape}.
However, the amplitude of this shape is expected to be tiny,
and the dominant contributions (the squeezed configurations) are expected
to have no observable effect~\cite{Cabass_2016}.


For the featureless DBI scenario, the shape function is~\cite{dbi_in_the_sky}:
\begin{align}\label{dbi_shape}
    %S^{DBI}(k_1,k_2,k_3) &= -\frac{1}{32}\frac{H^4}{12\varepsilon^2}\left(\frac{1}{c_s^2}-1\right)
    %     \frac{K_5+2K_{14}-3K_{23}+2K_{113}-8K_{122}}{K_{111}K^2}\\
    S^{DBI}(k_1,k_2,k_3) &= -\frac{35}{108}
         \left(\frac{1}{c_s^2}-1\right)
         6\left(\frac{H^2}{4\varepsilon c_s}\right)^2
         \left(\frac{3}{5}\right)
         \left(-\frac{3}{7}\right)
         \frac{K_5+2K_{14}-3K_{23}+2K_{113}-8K_{122}}{K_{111}K^2}
\end{align}
to leading order in slow-roll.
Any constraint on the magnitude of this template can be translated into one 
on the effective sound speed which from \planck~has a lower limit $c_s^{DBI} \geq 0.087$
at $95\%$ significance~\cite{Planck_NG_2015}.
The shape~\eqref{dbi_shape} can be approximated by the separable equilateral template~\eqref{equil_shape}.

    \subsection{Summary, scaling}
    There is an extensive literature on the calculation
of bispectra from models of inflation~\cite{chen_easther_lim_1,chen_easther_lim_2,chen_ng_0605,seery_ng_0503,px_burrage,adshead,flauger_pajer_resonant,features_bartolo,bdy_passaglia}.
Multi-field models can produce large
correlations between modes of very different scales;
non-canonical kinetic terms can reduce the sound speed of the perturbations,
boosting both the smooth non-Gaussian correlations, and any
features which may be present~\cite{dbi_adshead,dbi_in_the_sky,warp_features_dbi,dbi_silverstein,dbi_step_miranda,chen_folded_resonant,osc_avila};
effectively single-field models with imaginary sound speeds can generate a bispectrum
mostly orthogonal to the usual equilateral and local templates~\cite{RP_1}.
The methods outlined in this thesis have been implemented
and tested for single-field models,
with multi-field models being a prime target for future work.


These templates can be modified to be more physically realistic by including
scaling consistent with the spectral index $n_s$~\cite{Planck_NG_2015}.
For example, we can add some scale dependence to the DBI~\eqref{dbi_shape}
in a reasonable first approximation by including a prefactor.
We define the product scaling template
\begin{align}\label{dbi_prod_shape}
    S^{DBI-n_s}(k_1,k_2,k_3) &= {\left(\frac{k_1k_2k_3}{k^3_\star}\right)}^{\frac{n_{NG}}{3}}S^{DBI}(k_1,k_2,k_3)
\end{align}
and the sum scaling template
\begin{align}\label{dbi_sum_shape}
    S^{DBI-n_s}(k_1,k_2,k_3) &= {\left(\frac{k_1+k_2+k_3}{3k_\star}\right)}^{n_{NG}}S^{DBI}(k_1,k_2,k_3)
\end{align}
with $n_{NG}=2(-2\varepsilon-\varepsilon_s-\eta)-2\varepsilon_s=2(n_s-1)-2\varepsilon_s$.


Much success has been had in constraining non-Gaussianity
in the CMB using separable approximations to these approximate templates.
Other methods target oscillations~\cite{reso_estimator, excited_estimator},
by expanding the shape function
in $k_1+k_2+k_3$, thus limiting their ability to capture shapes whose
phase varies across the tetrapyd.
Our motivation in this work for directly calculating the primordial
bispectrum in a separable form is to build towards
a pipeline to constrain a broader section of the model space,
removing these layers of approximations,
though these standard results provide useful validation tests.
    \subsection{Shapes from features during inflation}
    Explicit details of how resonance and features generate large NG.
    Refer to~\ref{sec:inin_calc_example}.


For our more stringent validation tests we work with feature model scenarios
based on the above base models.
To explore non-Gaussianity coming from sharp features we include
a kink~\cite{Adams_step}
\begin{align}\label{eq:kink_potential}
    V(\phi) = \quadpot\left(1-c\tanh\left(\frac{\phi_f-\phi}{d}\right)\right).
\end{align}
To explore non-Gaussianity from deeper in the horizon we imprint
extended resonant features on the basic potential
\begin{align}\label{eq:resonant_potential}
    V(\phi) = \quadpot\left(1+bf\sin\left(\frac{\phi}{f}\right)\right).
\end{align}
For more details on these models, see~\cite{chen_easther_lim_2}.


We now turn to feature templates.
The result of adding a feature of the form~\eqref{eq:kink_potential}
is to add oscillatory features of the form
\begin{align}\label{cos_shape}
    S^{\cos}(k_1,k_2,k_3) = \cos(w(k_1+k_2+k_3))
\end{align}
though more realistically there is some phase, shape dependence and a modulating envelope,
as detailed in~\cite{adshead}.
The result of adding a resonant feature of the form~\eqref{eq:resonant_potential}
is to generate logarithmic oscillatory features in the shape function of the form
\begin{align}\label{ln_cos_shape}
    S^{\ln-\cos}(k_1,k_2,k_3) = \cos(w\ln(k_1+k_2+k_3)).
\end{align}
With a non-canonical kinetic term, this can also
cause out-of-phase oscillations in the folded limit as well as a modulating shape,
see~\cite{chen_folded_resonant}.



\section{Step 3: the $\cmb$ bispectrum}
    For a three dimensional statistical distribution projected onto
    a sphere, we expect the three-point statistics to be projected
    like (as in~\eqref{eq:bll})
    \begin{align}
        \left<f_{l_1m_1}f_{l_2m_2}f_{l_3m_3}\right> = B_{l_1l_2l_3}{{l_1~~l_2~~l_3} \choose {m_1~m_2~m_3}}
    \end{align}
    where ${{l_1~~l_2~~l_3} \choose {m_1~m_2~m_3}}$ enforces statistical isotropy.


    For the $\cmb$ in particular, we calculate the projected bispectrum using~\cite{FergShell_2}
    \begin{equation}
    \label{eq:reduced_cmb}
    b_{l_1l_2l_3} = \left(\frac{2}{\pi}\right)^3\int_{0}^{\infty}drr^2
        \int~d^3k (k_1k_2k_3)^2 B_{\Phi}(k_1,k_2,k_3)\prod_{i=1}^{3}\left[j_{l_i}(k_ir)\Delta_{l_i}(k_i)\right],
    \end{equation}
    analogously to~\eqref{eqn:transfer_function}.
    We see that the expression for the shape function $(k_1k_2k_3)^2 B_{\Phi}(k_1,k_2,k_3)$ appears directly.


    We will repeat the simple example outlined in~\cite{FergShell_2}. If we
    take $S(k_1,k_2,k_3)=1$ for all configurations, then the above four-dimensional integral
    simplifies greatly. If we also restrict to large angular scales ($l\ll200$)
    then we can use the \textcolor{red}{Sachs-Wolfe} approximation
    \begin{align}
        \Delta_l(k) = \frac{1}{3}j_l((\tau_0-\tau_{dec})k).
    \end{align}
    \textcolor{red}{How does this relate to $\chi_*$, and why $3$?}

    The integral becomes
    \begin{equation}
    \label{eq:reduced_cmb_constant}
    b_{l_1l_2l_3} = \left(\frac{2}{3\pi}\right)^3\int_{0}^{\infty}drr^2
        \int d^3k \prod_{i=1}^{3}\left[j_{l_i}(k_ir)j_l((\tau_0-\tau_{dec})k_i)\right].
    \end{equation}


    Now, using that
    \begin{align}
        \int_0^\infty dk~j_l(k)j_l(xk)\qquad=\qquad&\frac{\pi}{2}\frac{x^{-(l+1)}}{2l+1}\qquad&&\text{for $x>1$}\\
                            \qquad&\frac{\pi}{2}\frac{x^{l}}{2l+1}\qquad&&\text{for $x<1$}
    \end{align}
    we find that
    \begin{align}
    \label{eq:bll_constant}
        b_{l_1l_2l_3} &= \frac{f_{NL}}{27}\frac{1}{(2l_1+1)(2l_2+1)(2l_3+1)}
        \left[\int^1_0dx x^{l_1+l_2+l_3+2}+\int^\infty_1dx x^{-l_1-l_2-l_3-1}\right]\\
                &= \frac{f_{NL}}{27}\frac{1}{(2l_1+1)(2l_2+1)(2l_3+1)}
        \left[\frac{1}{l_1+l_2+l_3+3}+\frac{1}{l_1+l_2+l_3}\right].
    \end{align}
    Note that this example of constant $S$ is not especially realistic as a shape that could
    come from a model of inflation. Note also that the acoustic oscillations have not been taken
    into account here---these would imprint oscillations at higher $l$.
    Nevertheless, it is instructive to write down the scaling behaviour of this
    simple example, and to see how separability is lost between~\eqref{eq:reduced_cmb_constant}
    and~\eqref{eq:bll_constant} even for this simple case.


    \section{Step 4: $\cmb$ bispectrum estimation}
    \subsection{Linear regression}
    % https://arxiv.org/pdf/1006.1642.pdf
    % https://arxiv.org/pdf/0912.5516.pdf
    E.g.~\cite{Smith_2011, Komatsu_2005, Byun_1, Byun_2, modal_battefeld}.


Work on forecasting future constraints on features was performed
    in~\cite{Sohn_2019} \textcolor{red}{Where else?}
    For recent reviews, see~\cite{astro2020_png, astro2020_features, Ballardini_2017, Sypsas_2017,
    Palma_2017}.
    While there are some standard shapes with very tight constraints,
    there are still regions of the model space that have not been constrained.


    The bispectrum derived from theory is denoted
    \begin{align}
        \left<\triplea\right>
    \end{align}
    whereas the bispectrum measured from the $\cmb$ is
    \begin{align}
        B^{l_1l_2l_3}_{m_1m_2m_3} &= \tripleaobs.
    \end{align}
    We also have
    \begin{align}\label{eq:bll}
        B_{l_1l_2l_3} = \sum_{m_i} {{l_1~~l_2~~l_3} \choose {m_1~m_2~m_3}} B^{l_1l_2l_3}_{m_1m_2m_3}.
    \end{align}


    The standard method for estimating the $\cmb$ bispectrum is to calculate the least squares
    fit between the theory bispectrum and the observed bispectrum. That is, we find $\lambda$
    such that the following expression is minimised:
    \begin{align}
        \sum_{l_i,m_i}{\left(\lambda\frac{\left<\triplea\right>}{\sqrt{C_{l_1}C_{l_2}C_{l_3}}}
                - \frac{\tripleaobs}{\sqrt{C_{l_1}C_{l_2}C_{l_3}}}\right)}^2.
    \end{align}
    The solution to this is simply
    \begin{align}
        \lambda = \frac{\frac{\left<\triplea\right>}{\sqrt{C_{l_1}C_{l_2}C_{l_3}}}\cdot\frac{\tripleaobs}{\sqrt{C_{l_1}C_{l_2}C_{l_3}}}}{\left|\frac{\left<\triplea\right>}{\sqrt{C_{l_1}C_{l_2}C_{l_3}}}\right|^2}
    \end{align}
    where $\cdot$ denotes summation over $l_i$ and $m_i$.
    Defining
    \begin{align}
        N = \left|\frac{\left<\triplea\right>}{\sqrt{C_{l_1}C_{l_2}C_{l_3}}}\right|^2
    \end{align}
    we can rewrite this in the usual way (with $\lambda$ identified as the result of the estimator $\mathcal{E}$)
    \begin{align}
        \mathcal{E} = \frac{1}{N}\sum_{l_i,m_i}\frac{\left<\triplea\right>\tripleaobs}{C_{l_1}C_{l_2}C_{l_3}}.
    \end{align}
    However, if we simply calculate this quantity for some theoretical model we will not be able to
    interpret the result. This is because even a $\cmb$ sky in a universe with initial conditions
    drawn from a purely Gaussian distribution could, through random chance,
    result in a non-zero $\mathcal{E}$. This problem is solved using Gaussian maps.
    Many $\cmb$ are generated from Gaussian initial conditions, and then the estimator
    is applied to each. This gives a distribution of $\mathcal{E}$, from which we can
    calculate $1\sigma$ and $2\sigma$ regions for $\mathcal{E}$. Then the result of the
    estimator (when applied to the real $\cmb$ sky) can be compared to this distribution
    to determine the significance of the result.


    This procedure must be modified to account for experimental noise, beam effects and
    the presence of a mask (to exclude to regions of the sky saturated by our galaxy).
    The assumption is also made that the covariance matrix is diagonal, and the
    following quantities are defined:
    \begin{align}
        C_{l_1m_1,l_2m_2}&\approx C_l\delta_{l_1l_2}\delta_{m_1~-m_2},\label{diagonal_covariance}\\
           \tilde{C_l} &= b_l^2C_l+N_l,\\
           \bar{b}_{l_1l_2l_3} &= b_{l_1}b_{l_2}b_{l_3}b_{l_1l_2l_3}.
    \end{align}
    so that the estimator can be written as
    \begin{align}
        \mathcal{E} = \frac{1}{\bar{N}^2}\sum_{l_im_i}
        \frac{\mathcal{G}^{l_1l_2l_3}_{m_1m_2m_3}\bar{b}_{l_1l_2l_3}}{\tilde{C}_{l_1}\tilde{C}_{l_2}\tilde{C}_{l_3}}
        \left(\triplea-6C^{sim}_{l_1m_1,l_2m_2}a_{l_3m_3}\right).
    \end{align}
    \textcolor{red}{What are the beam effects? What is the noise? What approximations go into this?
    What are the references for those? That 6 should be a 3. Replace $C^{sim}$ with $C$, mention
    that in practice it is calculated using simulations.}
    We have here used the Gaunt integral
    \begin{align}
        \mathcal{G}^{l_1l_2l_3}_{m_1m_2m_3} &= \int d\Omega Y_{l_1m_1}\nhatbrkt Y_{l_2m_2}\nhatbrkt Y_{l_3m_3}\nhatbrkt \\
        &= h_{l_1l_2l_3}{{l_1~~l_2~~l_3} \choose {m_1~m_2~m_3}},
    \end{align}
    and we can then define
    \begin{align}
        b_{l_1l_2l_3} = h^{-1}_{l_1l_2l_3}B_{l_1l_2l_3}.
    \end{align}


    \subsection{Complexity of bispectrum estimation}

\textcolor{red}{
Memory bound computation, so tabulation won't help. The time is due to moving data.
Not much to do with the maps?}


    The bispectrum, like the power spectrum, is a quantity that describes
the statistical distribution of which our universe is only one realisation.
We use this one sky we have access to to estimate the amplitude of
particular bispectrum templates,
and use these estimates to constrain inflationary physics; 
see~\cite{astro2020_features,astro2020_png} for recent reviews.
There are two parts to the pipeline of bispectrum estimation.
Firstly, calculating the primordial bispectrum at the end of some inflation scenario,
and then calculating the effect this bispectrum
has on some appropriate observable today.
One well-developed example is
the bispectrum of temperature fluctuations in the CMB, which uses transfer functions
(which we saw previously in~\eqref{eqn:transfer_function})
to evolve and project the primordial bispectrum onto our sky.
In principle, this is the same process as power spectrum estimation.
However, for the bispectrum the computational challenge is far greater,
requiring both compute-intensive and large in-memory components.


As a result of this complexity, this second step is computationally impractical for generic primordial bispectra.
Progress can be made by finding an approximation to the primordial shape
that is separable, and using this simplification
to make the calculation tractable
through the KSW estimator~\cite{Komatsu_2005, Munchmeyer_2014}.
For example, one may find that a particular inflation scenario generates
a primordial bispectrum with a high correlation with some standard shape,
then look at how well that standard shape is constrained by the CMB.
The modal decomposition method of~\cite{FergShell_1,FergShell_2,FergShell_3}
leveraged these simplifications in a more structured way
for generic bispectra, broadening the range of constrained models.


The measure of non-Gaussianity in the CMB that is
most usually quoted is $\fnl$, referring to $\fnllocal$.
This number describes how well a particular template, the local template,
describes the correlations in the CMB;
this template is used as a proxy for the class of inflation models that produce similar bispectra.
Similar quantities for the equilateral and orthogonal templates are also
commonly quoted.
In addition to broadening the range of constrained models through increases in efficiency,
the modal decomposition method of~\cite{FergShell_1,FergShell_2,FergShell_3}
allows to go beyond this paradigm, efficiently constraining inflationary bispectra in the CMB using
all of the shape information; essentially constraining an $\fnl$
specific to a given bispectrum. This bypasses the approximation step at the level of the templates,
of finding a separable approximation to the primordial bispectrum.
In this work, our numerical methods remove the need for some of the approximations
made before this, during inflation, directly linking the parameters of the inflation scenario
with the relevant observable.
In addition to this improvement in accuracy, calculating the modal decomposition
directly from the model of inflation is far more efficient 
than numerically calculating the bispectrum configuration by configuration.


If the shape function~\eqref{shapefn} has the form:
\begin{equation}\label{sepXYZ}
S(k_1,k_2,k_3) = X(k_1)Y(k_2)Z(k_3),
\end{equation}
or can be expressed as a sum of such terms,
it is called separable.
The link between the separability of the primordial bispectrum
and the reduced CMB bispectrum can be seen from~\eqref{eq:reduced_cmb},
where we also see that if the primordial bispectrum is separable
then the overall dimension
of the calculation can be reduced from seven to five, 
since the spherical Bessel functions $j_{l_i}$ and the
transfer functions $\Delta_{l_i}$ already appear in a separable way.
This property can also be used to
efficiently generate non-Gaussian initial conditions
for simulations~\cite{Scoccimarro_2012}.


The numbers $\fnl^F$ are useful summary parameters.
From the data-side, they represent the result of
a complex and intensive process
of estimating the amplitude of the template $F$,
given some data. From the theory-side, one
can use them to take an inflation scenario and compare it
to that data, if one can find a standard template
with a high correlation with the shape resulting
from that scenario.
However, despite its usefulness, this paradigm does
have drawbacks. It acts as an information bottleneck,
losing some constraining power when one approximates
the real shape function by some standard template.
In particular, if one is interested in a feature model,
it may be be difficult to see how constraints on existing
features can be applied.


\section{Previous work on in-in separability.}
    In~\cite{Funakoshi} it was pointed out that one can compute using the
tree-level in-in formalism in such a way as to preserve its intrinsic
separability. In addition to making this point,~\cite{Funakoshi} lays
out some of the basic structure of an implementation of that computation,
and validates the method on simple, featureless scenarios.
This work built on the philosophy of~\cite{FergShell_1,FergShell_2,FergShell_3}
in which a formalism was developed to
leverage the tractability of separable CMB bispectrum estimation
for generic primordial bispectra, by expanding them in a separable basis.
The results of these methods (not using the work of~\cite{Funakoshi})
are constraints on the parameters of certain inflation models through approximate
phenomenological templates.
These constraints can be found in~\cite{Planck_NG_2015, Planck_NG_2018}.
The idea of~\cite{Funakoshi} is an extension of that philosophy to the primordial level,
and our work is in implementing that idea.
In~\cite{FergShell_1,FergShell_2,FergShell_3} an orthogonal basis on the tetrapyd was used,
removing the need to fit non-physical configurations.
One of the main differences between that work and this
is that we cannot use this basis here without sacrificing the
in-in separability we are trying to preserve.

In this work we explore the details of this calculation in much greater detail
than was considered in~\cite{Funakoshi}.
We restructure the methods, improving on the work of~\cite{Funakoshi} in terms
of flexibility of basis choice and efficiency of the calculation.
We also detail a particular set of basis functions that improves upon those described
in~\cite{Funakoshi} in its rate of convergence, its transparency,
and its flexibility.
We do this without sacrificing orthogonality.
This is detailed in chapter~\ref{chapter:decomp}.
Our improvements over the methods sketched in~\cite{Funakoshi} allow us to validate
on non-trivial bispectra for the first time, including sharp deviations from slow-roll, which we present in
section~\ref{sec:validation}.
We quote our results in terms of a measure that is
easier to interpret than the correlation defined in~\cite{Funakoshi},
and that includes the magnitude as well as the shape information
on the full tetrapyd.
This is discussed in section~\ref{sec:inner_product}.
    %\subsection{Comparison to the present work}


    \textcolor{red}{Summary of the achievements and limitations of~\cite{Funakoshi}, how I went beyond them.}
    \section{Configuration-by-configuration codes}
    Cite~\cite{Ringeval}.
    Previous work on the numerical calculations of inflationary
non-Gaussianity include the BINGO code~\cite{BINGO},
Chen et al~\cite{chen_easther_lim_1,chen_easther_lim_2},
the work of Horner et al~\cite{horner_methods,horner_ng,horner_cs}
and the Transport Method~\cite{transport_main,transport_pytransport,transport_pytransport_2,transport_curved_3_point}.
All but the last directly apply the tree-level in-in formalism $k$-configuration by $k$-configuration for a given model;
they integrate a product of three mode functions and a background-dependent term from the interaction Hamiltonian, of form similar to~\eqref{inin_sep}.
The eventual result is a grid of points representing the primordial bispectrum.


The most advanced publicly released code for the calculation of inflationary perturbations
is based on the Transport Method.
Like the previously mentioned work it calculates the bispectrum $k$-configuration by $k$-configuration.
However the method is different in its details.
Instead of performing integrals,
a set of coupled ODEs is set up and solved.
The power spectra and bispectra themselves are evolved, their time derivatives calculated by
differentiating the in-in formalism.\footnote{
    See~\ref{appendix_modal_transport}
    for details on why we did not apply this strategy to our own modal coefficients.
    }
The publicly released code is very sophisticated,
able to deal with multiple fields in curved field spaces,
recently being used to explore the bispectra resulting from
sidetracked inflation~\cite{RP_1}.
    \subsection{Usage in recent works}
    \textcolor{red}{CHECK ALL THIS.}
    In~\cite{RP_1, Fumagalli_2019} and especially
    in~\cite{Marzouk_D3}, a large ensemble of inflationary trajectories is considered
    using the transport method~\cite{transport_pytransport_2}.
    For these trajectories, the bispectrum is calculated for a certain number of $k$-configurations---in
    these papers, $\fnlequil$ and $\fnl^{flat}$ refer to the definition given in~\eqref{transport_fnl_defn}
    evaluated on equilateral and flat configurations respectively.
    In these works it was found that squeezed limit configurations were much more
    difficult to calculate using that software. While this analysis is very sophisticated, much
    information is lost due to taking the bispectrum at points only, and not using the full
    inflationary shape function.
    % See figure 2 and 20 for their time taken, which is ~100s, for 6(?) scalar fields.
    \subsection{Limitations}
    However despite the differences, all configuration-by-configuration methods face the same problems:
firstly, that calculating enough points in the bispectrum to ensure that
the whole picture has been captured is expensive, especially for non-trivial features.
Even once that has been achieved, what is obtained is a grid of points
which must be processed further to be usefully compared to observation.
Secondly, they must carefully implement some variation
of the $i\eps$ prescription without affecting the numerical results.
In~\cite{transport_main} this is achieved in the initial conditions for the bispectra;
other methods impose some non-trivial cutoff at early times.


    \section{Separable approximations to non-separable templates}
    Separability is required, so usually one approximates non-separable templates
    by separable ones.
    For example, the~\eqref{dbi_shape} is closely approximated by the equilateral
    template~\eqref{equil_shape}.
    \textcolor{red}{Quantitative comparison of equilateral template and DBI shape,
    with and without scaling.}


    KSW-type estimators take as their starting point the realisation that many
    templates can be rewritten as a simple finite sum of separable functions.
    For example, the simple local~\eqref{local_shape}, equilateral~\eqref{equil_shape} and orthogonal~\cite{Planck_NG_2013}
    templates can be built up from a small set of
    simple monomials, namely $k^{-1}$, $1$, $k$ and $k^{2}$.
    This method is able to constrain shapes with that contain very high frequency linear oscillations\footnote{
    Since $e^{iw(k_1+k_2+k_3)}=e^{iwk_1}e^{iwk_2}e^{iwk_3}$.},
    but is limited in that it cannot function for shapes whose shape dependence is not
    sum-separable.


    The Modal method~\cite{FergShell_2014} is more versatile, 
    leveraging the benefits of separability in a broader set of models through expansion.
    For example, this method can deal with primordial templates with envelopes.
    The Modal code proceeds using two sets of basis functions, one in $k$ space at the end
    of inflation, and another in $l$ space for the $\cmb$.
    For a given primordial template, the best-fit linear combination of the primordial basis
    is found, generating a set of coefficients.
    The template need not be a sum of separable functions, but should be well-approximated by this
    decomposition in the primordial basis.
    The coefficients of this decomposition are then projected onto the $\cmb$ basis, to calculate the constraint.


    \textcolor{red}{These methods have been used to obtain constraints\ldots}
    \section{$\cmbbest$}
    The method implemented in $\cmbbest$~\cite{Sohn_2021} is roughly a generalisation of the KSW method.
    Contrasting the Modal method, $\cmbbest$ requires only one basis, a primordial one, in $k$ space.
    This basis is then projected forwards onto the $\cmb$. This is a massively resource-intensive calculation
    with the naive implementation scaling as $\Pmax^6$ and requiring terabytes of RAM for reasonable method parameters,
    which slow the calculation due to the need to move data back and forth \textcolor{red}{because data
    is really heavy and hard to carry}.
    This calculation was tackled in~\cite{Sohn_2021}, which implemented optimisations which allowed this calculation
    to be run for $\Pmax=30$ using reasonable supercomputer resources. The motivation for implementing this algorithmically
    and numerically difficult calculation is that it need only be done once per basis. Once it is done, then
    any primordial bispectrum represented in that basis can be constrained in the $\cmb$ immediately.


    $\cmbbest$ is a generalisation of the KSW method in the sense that for a specific choice of basis, it simplifies
    to the KSW method. However, by choosing a more descriptive basis set (for example, one of the basis sets we have developed
    in chapter~\ref{chapter:decomp}) a much broader range of models can be constrained. This was one of our main
    motivations in carefully exploring and comparing the basis sets in chapter~\ref{chapter:decomp},
    as more descriptive basis sets translate directly into more constraints on inflationary models.


    The quantity in~\eqref{diagonal_covariance} is not assumed to be diagonal\textcolor{red}{CHECK THIS},
    it is calculated by taking an
    ensemble average of $140$ Gaussian simulations. $\fnl$ estimates are made for all of these simulations,
    with the results found to be distributed normally. The variance of this distribution then provides us with
    a measure to assess the significance of any $\fnl$ detection in the true $\cmb$.


    The convergence of the final estimate is always the primary arbiter for setting method
    parameters, even at the primordial level. It was shown in~\cite{Sohn_2021} that the ratio of $\kmax$
    to $\kmin$ was important in determining the success of the method. If $\kmax/\kmin$ was too small
    then important information was lost, and validation estimates of $\fnl$ for the local shape
    did not agree with previous methods. In that work it was determined that $\kmax/\kmin=1000$ was
    sufficient, hence that is the value we will use in testing out basis sets
    \textcolor{red}{CHECK THIS!!!}.






